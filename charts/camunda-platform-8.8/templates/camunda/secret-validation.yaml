{{/*
This template validates the enhanced secret configurations and shows warnings for deprecated usage.
It is included as a ConfigMap to ensure warnings are displayed during helm operations.
*/}}
{{- if .Values.global.identity.auth.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "camundaPlatform.fullname" . }}-secret-validation
  labels:
    {{- include "camundaPlatform.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
    {{- toYaml .Values.global.annotations | nindent 4 }}
data:
  validation-results: |
    # Enhanced Secret Configuration Validation Results
    
    {{- /* Validate identity.firstUser */ -}}
    {{- if .Values.identity.firstUser.enabled }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.identity.firstUser.secret "oldPassword" .Values.identity.firstUser.password "oldExistingSecret" .Values.identity.firstUser.existingSecret "componentName" "identity.firstUser" "context" .) }}
    {{- end }}
    
    {{- /* Validate OAuth client secrets */ -}}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.identity.auth.admin.secret "oldPassword" "" "oldExistingSecret" .Values.global.identity.auth.admin.existingSecret "componentName" "global.identity.auth.admin" "context" .) }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.identity.auth.identity.secret "oldPassword" "" "oldExistingSecret" .Values.global.identity.auth.identity.existingSecret "componentName" "global.identity.auth.identity" "context" .) }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.identity.auth.console.secret "oldPassword" "" "oldExistingSecret" .Values.global.identity.auth.console.existingSecret "componentName" "global.identity.auth.console" "context" .) }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.identity.auth.connectors.secret "oldPassword" "" "oldExistingSecret" .Values.global.identity.auth.connectors.existingSecret "componentName" "global.identity.auth.connectors" "context" .) }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.identity.auth.core.secret "oldPassword" "" "oldExistingSecret" .Values.global.identity.auth.core.existingSecret "componentName" "global.identity.auth.core" "context" .) }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.identity.auth.optimize.secret "oldPassword" "" "oldExistingSecret" .Values.global.identity.auth.optimize.existingSecret "componentName" "global.identity.auth.optimize" "context" .) }}
    
    {{- /* Validate license */ -}}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.license.secret "oldPassword" .Values.global.license.key "oldExistingSecret" .Values.global.license.existingSecret "componentName" "global.license" "context" .) }}
    
    {{- /* Validate external secrets */ -}}
    {{- if .Values.webModeler.enabled }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.webModeler.restapi.externalDatabase.secret "oldPassword" .Values.webModeler.restapi.externalDatabase.password "oldExistingSecret" .Values.webModeler.restapi.externalDatabase.existingSecret "componentName" "webModeler.restapi.externalDatabase" "context" .) }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.webModeler.restapi.mail.secret "oldPassword" .Values.webModeler.restapi.mail.smtpPassword "oldExistingSecret" .Values.webModeler.restapi.mail.existingSecret "componentName" "webModeler.restapi.mail" "context" .) }}
    {{- end }}
    
    {{- if .Values.global.elasticsearch.external }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.elasticsearch.auth.secret "oldPassword" .Values.global.elasticsearch.auth.password "oldExistingSecret" .Values.global.elasticsearch.auth.existingSecret "componentName" "global.elasticsearch.auth" "context" .) }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.elasticsearch.tls.secret "oldPassword" "" "oldExistingSecret" .Values.global.elasticsearch.tls.existingSecret "componentName" "global.elasticsearch.tls" "context" .) }}
    {{- end }}
    
    {{- if .Values.global.opensearch.enabled }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.opensearch.auth.secret "oldPassword" .Values.global.opensearch.auth.password "oldExistingSecret" .Values.global.opensearch.auth.existingSecret "componentName" "global.opensearch.auth" "context" .) }}
    {{ include "camundaPlatform.validateSecretConfig" (dict "newSecretConfig" .Values.global.opensearch.tls.secret "oldPassword" "" "oldExistingSecret" .Values.global.opensearch.tls.existingSecret "componentName" "global.opensearch.tls" "context" .) }}
    {{- end }}
    
    # Validation completed. Check above for any warnings or deprecation notices.
{{- end }}